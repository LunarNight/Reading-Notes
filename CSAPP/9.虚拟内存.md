#9.虚拟内存
 进程是与其他进程共享CPU和主存资源的.然而,共享主存会形成一些特殊的挑战.随着对CPU需求的增长,进程以某种合理的平滑方式慢下来.但是如果太多的进程需要太多的内存,那么它们中的一些根本无法运行.当一个程序没有空间可用时.内存还很容易被破坏.如果某个进程不小心写了另一个进程使用的内存,它就可能以某种完全和程序逻辑无关的令人迷惑的方式失败.  
 为了更加有效地管理内存并且少出错,现代系统提供了一种对主存的抽象概念,叫做**虚拟内存(VM)**.虚拟内存是硬件异常,硬件地址翻译,主存,磁盘文件和内核软件的完美交互,它为每个进程提供了一个大的,一直的和私有的地址空间.通过一个清晰的机制,虚拟内存提供了三个重要的能力: 1)它将主存看成是一个存储在磁盘上的地址空间的告诉缓存,在主存中只保存活动区域,并根据需要在磁盘和主存之间来回传送数据,通过这种方式高效地使用了主存. 2)它为每个进程提供了一致的地址空间,从而简化了内存管理. 3)它保存了每个进程的地址空间不被其他进程破坏.  
 虚拟内存是计算机系统最重要的概念之一.它成功的一个主要原因就是因为它是沉默地,自动地工作的,不需要应用程序员的任何干涉.  
 需要理解它的原因:  
 + **虚拟内存是核心的.**虚拟内存遍及计算机系统的所有层面,在硬件异常,汇编器,链接器,加载器,共享对象,文件和进程的设计中扮演着重要角色.理解虚拟内存可以更好地理解系统通常是如何工作的.  
 + **虚拟内存是强大的.**虚拟内存基于应用程序强大的能力,可以创建和销毁内存片(chunk),将内存片映射到磁盘文件的某个部分,以及与其他进程共享内存.比如,通过读写内存位置或者修改一个磁盘文件的内容,可以加载一个文件的内容到内存,而不需要进行任何显式地复制.理解虚拟内存将帮助你利用它的强大功能在应用程序中添加动力.  
 + **虚拟内存是危险的**.每次应用程序引用一个变量,间接引用一个指针,或者调用一个诸如malloc这样的动态分配程序时,它就会和虚拟内存发生交互.如果虚拟内存使用不当,应用将遇到复杂危险的与内存有关的错误.刘丽茹,一个带有错误指针的程序可以立即崩溃于"段错误"或者"保护错误",它可能在崩溃之前还默默地运行了几个小时,或者是最令人惊慌地,运行完成却产生不正确的结果.  
  
前一部分描述虚拟内存是如何工作的.后一部分描述的是应用程序如何使用和管理虚拟内存.
##9.1 物理和虚拟寻址
 计算机系统的主存被组织成一个由M个连接的字节大小的单元组成的数组.每字节都有一个唯一的物理地址.CPU访问内存的最自然的方式就是使用物理地址.我们把这种方式称为物理寻址.  
 现代处理器使用的是一种称为虚拟寻址的寻址形式,CPU通过生成一个**虚拟地址(Virtual Address,VA)**来访问主存,这个虚拟地址在被送到内存之前先转换成适当的物理地址.将一个虚拟地址转换为物理地址的任务叫做**地址翻译**.  
##9.2 地址空间
 **地址空间(address space)**是一个非负整数地址的有序集合.  
 如果地址空间中的正数是连续的,那么我们说它是一个线性地址空间(linear address space).为了简化讨论,总是假设使用的是线性地址空间.  
 一个地址空间的大小是由表示最大地址所需要的位数来描述的.例如,一个包含N=2<sup>n</sup>个地址的虚拟地址空间就叫做一个n位地址空间.现代操作系统通常支持32位或者64位虚拟地址空间.  
 一个系统还有一个物理地址空间,对应于系统中物理内存的M个字节.  
 地址空间的概念很重要,它清楚地区分了数据对象(字节)和它们的属性(地址).**允许每个数据对象有多个独立的地址,每个地址都选自一个不同的地址空间.这就是虚拟内存的基本思想**.主存中的每字节都有一个选自虚拟地址空间的虚拟地址和一个选自物理地址空间的物理地址.  
##9.3 虚拟内存作为缓存的工具
 **虚拟内存**被组织为一个由**存放在磁盘上**的N个连续的字节大小的单元组成的**数组**.每字节都有一个唯一的虚拟地址,作为到数组的索引.磁盘上数组的内容被缓存在主存中.和存储器层次结构中其他缓存一样,磁盘(较低层)上的数据被分割成块,这些块作为磁盘和主存(较高层)之间的传输单元.VM系统通过将虚拟内存分割为称为**虚拟页(Vittual Page,VP)**的大小固定的块来处理这个问题.每个虚拟页的大小为P=2<sup>p</sup>字节.类似地,物理内存被分割为物理页,大小也为P字节(物理页也被称为页帧).  
 在任意时刻,虚拟页面的集合都分为三个不相交的子集:  
 + 未分配的:VM系统还未分配(或者创建)的页.未分配的块没有任何数据和它们相关联,因此也就不占用任何磁盘空间.  
 + 缓存的: 当前已缓存在物理内存中的已分配页.  
 + 未缓存的:未缓存在物理内存中的已分配页.  
  
###9.31 DRAM缓存的组织结构
 
